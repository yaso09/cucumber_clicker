<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SalatalÄ±k DoÄŸra</title>

<style>
/* === CSS AYNEN KORUNDU === */
* {
  box-sizing: border-box;
  user-select: none;
  touch-action: manipulation;
  font-family: system-ui, sans-serif;
}
body { margin: 0; background: #0f0f0f; color: #fff; }
#game { display: flex; flex-direction: column; height: 100vh; }
header { display: flex; justify-content: space-between; padding: 12px; background: #1b1b1b; font-weight: bold; }
main { flex: 1; display: flex; justify-content: center; align-items: center; }
#chop-area { position: relative; width: 260px; height: 260px; }
#knife { position: absolute; top: -60px; left: 50%; width: 130px; transform: translateX(-50%) rotate(-12deg); z-index: 1; }
#knife.chop { animation: knifeChop 0.28s cubic-bezier(.2,.8,.2,1); }

@keyframes knifeChop {
  0% { transform: translateX(-50%) translateY(0) rotate(-12deg); }
  60% { transform: translateX(-50%) translateY(135px) rotate(28deg); }
  100% { transform: translateX(-50%) translateY(0) rotate(-12deg); }
}

#cucumber { position: absolute; bottom: 35px; left: 50%; width: 190px; transform: translateX(-50%); }

.slice {
  position: absolute;
  width: 70px;
  bottom: 70px;
  left: 50%;
  transform: translateX(-50%);
  animation: sliceFall 1.1s cubic-bezier(.25,.6,.25,1) forwards;
}

@keyframes sliceFall {
  to {
    transform: translateX(calc(-50% + var(--x))) translateY(200px) rotate(var(--r));
    opacity: 0;
  }
}

nav { display: flex; padding: 10px; background: #1b1b1b; }
nav button { flex: 1; margin: 0 5px; padding: 12px; border-radius: 14px; border: none; background: #2a2a2a; color: #fff; font-size: 16px; }

.modal { position: fixed; inset: 0; background: #0f0f0ff5; padding: 20px; z-index: 100; overflow-y: auto; }
.hidden { display: none; }
.item { background: #1f1f1f; padding: 12px; border-radius: 12px; margin-bottom: 12px; }
.factory { border: 1px solid #333; }
.bar { height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin: 6px 0; }
.bar > div { height: 100%; background: #4caf50; }
.factory button { margin-top: 6px; margin-right: 6px; }
.close { width: 100%; padding: 12px; background: #444; border: none; color: white; border-radius: 10px; }

canvas { width: 100%; height: 120px; background: #111; border-radius: 10px; margin-top: 10px; }
</style>
</head>

<body>
<div id="game">

<header>
  <div>ğŸ¥’ <span id="count">0</span></div>
  <div>Click: <span id="perClick">1</span></div>
</header>

<main>
  <div id="chop-area">
    <img id="knife" src="/assets/images/knife_basic.svg">
    <img id="cucumber" src="/assets/images/cucumber.svg">
  </div>
</main>

<nav>
  <button onclick="openModal('market')">ğŸ›’ Market</button>
  <button onclick="openModal('factories')">ğŸ­ Fabrikalar</button>
</nav>
</div>

<div id="market" class="modal hidden">
<h2>Market</h2>
<div class="item">
<strong>Mini Fabrika</strong>
<p>Ãœretim: 1/sn | Can: 100</p>
<button onclick="buyFactory()">150 ğŸ¥’</button>
</div>
<button class="close" onclick="closeModals()">Kapat</button>
</div>

<div id="factories" class="modal hidden">
<h2>FabrikalarÄ±m</h2>
<div id="factoryList"></div>

<h3>Verim GrafiÄŸi</h3>
<canvas id="chart"></canvas>

<button class="close" onclick="closeModals()">Kapat</button>
</div>

<script>
/* ===== STATE ===== */
let state = JSON.parse(localStorage.salatalik || "{}");
Object.assign(state,{
  cucumbers:state.cucumbers||0,
  perClick:1,
  factories:state.factories||[],
});

const countEl = document.getElementById("count");
const perClickEl = document.getElementById("perClick");
const knifeEl = document.getElementById("knife");
const chopArea = document.getElementById("chop-area");
const factoryList = document.getElementById("factoryList");
const chart = document.getElementById("chart");
const ctx = chart.getContext("2d");

/* === GRAPH DATA === */
let historyClick = [];
let historyFactory = [];
let clickProduction = 0;

/* === CORE === */
function save(){localStorage.salatalik=JSON.stringify(state)}
function updateUI(){
  countEl.textContent=Math.floor(state.cucumbers);
  perClickEl.textContent=state.perClick;
}

/* === CHOP === */
chopArea.onclick=()=>{
  if(document.querySelector(".modal:not(.hidden)"))return;
  state.cucumbers+=state.perClick;
  clickProduction+=state.perClick;

  knifeEl.classList.remove("chop");
  void knifeEl.offsetWidth;
  knifeEl.classList.add("chop");

  spawnSlice();
  save();updateUI();
};

function spawnSlice(){
  const s=document.createElement("img");
  s.src="/assets/images/cucumber_part.svg";
  s.className="slice";
  s.style.setProperty("--x",`${Math.random()*140-70}px`);
  s.style.setProperty("--r",`${Math.random()*220-110}deg`);
  chopArea.appendChild(s);
  setTimeout(()=>s.remove(),1100);
}

/* === FACTORIES === */
function buyFactory(){
  if(state.cucumbers<150)return;
  state.cucumbers-=150;
  state.factories.push({
    level:1,
    power:1,
    health:100,
    maxHealth:100
  });
  save();updateFactories();updateUI();
}

function repairFactory(i){
  let f=state.factories[i];
  if(state.cucumbers<20)return;
  state.cucumbers-=20;
  f.health=Math.min(f.maxHealth,f.health+30);
  save();updateFactories();updateUI();
}

function upgradeFactory(i){
  let f=state.factories[i];
  if(state.cucumbers<50)return;
  state.cucumbers-=50;
  f.level++;
  f.maxHealth+=20;
  f.health=f.maxHealth;
  save();updateFactories();updateUI();
}

function updateFactories(){
  factoryList.innerHTML="";
  state.factories.forEach((f,i)=>{
    const eff=f.health/f.maxHealth;
    const prod=f.power*f.level*eff;
    const div=document.createElement("div");
    div.className="item factory";
    div.innerHTML=`
      <strong>Fabrika #${i+1} (Lv ${f.level})</strong>
      <p>Ãœretim: ${prod.toFixed(2)}/sn</p>
      <div class="bar"><div style="width:${eff*100}%"></div></div>
      <button onclick="repairFactory(${i})">Tamir (20)</button>
      <button onclick="upgradeFactory(${i})">Upgrade (50)</button>
    `;
    factoryList.appendChild(div);
  });
}

/* === TICK === */
setInterval(()=>{
  let factoryProd=0;

  state.factories.forEach(f=>{
    if(f.health>0){
      let p=f.power*f.level*(f.health/f.maxHealth);
      factoryProd+=p;
      state.cucumbers+=p;
      f.health=Math.max(0,f.health-0.08); // yavaÅŸ aÅŸÄ±nma
    }
  });

  historyClick.push(clickProduction);
  historyFactory.push(factoryProd);
  if(historyClick.length>60){
    historyClick.shift();
    historyFactory.shift();
  }
  clickProduction=0;

  drawChart();
  updateUI();updateFactories();save();
},1000);

/* === GRAPH === */
function drawChart(){
  chart.width=chart.clientWidth;
  chart.height=chart.clientHeight;
  ctx.clearRect(0,0,chart.width,chart.height);

  const max=Math.max(...historyClick,...historyFactory,1);
  ctx.lineWidth=2;

  ctx.strokeStyle="#4caf50";
  ctx.beginPath();
  historyFactory.forEach((v,i)=>{
    const x=i*(chart.width/60);
    const y=chart.height-(v/max)*chart.height;
    if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  ctx.strokeStyle="#2196f3";
  ctx.beginPath();
  historyClick.forEach((v,i)=>{
    const x=i*(chart.width/60);
    const y=chart.height-(v/max)*chart.height;
    if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

/* === MODALS === */
function openModal(id){document.getElementById(id).classList.remove("hidden")}
function closeModals(){document.querySelectorAll(".modal").forEach(m=>m.classList.add("hidden"))}

/* INIT */
updateUI();updateFactories();
</script>
</body>
</html>

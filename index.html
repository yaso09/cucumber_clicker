<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SalatalÄ±k DoÄŸra</title>

<style>
* {
  box-sizing: border-box;
  user-select: none;
  touch-action: manipulation;
  font-family: system-ui, sans-serif;
}

body {
  margin: 0;
  background: #0f0f0f;
  color: #fff;
}

/* ===== LAYOUT ===== */
#game {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

header {
  display: flex;
  justify-content: space-between;
  padding: 12px;
  background: #1b1b1b;
  font-weight: bold;
}

main {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ===== CHOP AREA ===== */
#chop-area {
  position: relative;
  width: 260px;
  height: 260px;
}

#knife {
  position: absolute;
  top: -60px;
  left: 50%;
  width: 130px;
  transform: translateX(-50%) rotate(-12deg);
  z-index: 1;
}

#knife.chop {
  animation: knifeChop 0.25s cubic-bezier(.2,.8,.2,1);
}

@keyframes knifeChop {
  0%   { transform: translateX(-50%) translateY(0) rotate(-12deg); }
  60%  { transform: translateX(-50%) translateY(130px) rotate(25deg); }
  100% { transform: translateX(-50%) translateY(0) rotate(-12deg); }
}

#cucumber {
  position: absolute;
  bottom: 35px;
  left: 50%;
  width: 190px;
  transform: translateX(-50%);
}

.slice {
  position: absolute;
  width: 40px;
  bottom: 60px;
  left: 50%;
  transform: translateX(-50%);
  animation: sliceFall 0.8s ease-out forwards;
}

@keyframes sliceFall {
  to {
    transform: translateX(calc(-50% + var(--x))) translateY(160px) rotate(var(--r));
    opacity: 0;
  }
}

/* ===== NAV ===== */
nav {
  display: flex;
  padding: 10px;
  background: #1b1b1b;
}

nav button {
  flex: 1;
  margin: 0 5px;
  padding: 12px;
  border-radius: 14px;
  border: none;
  background: #2a2a2a;
  color: #fff;
  font-size: 16px;
}

/* ===== MODAL ===== */
.modal {
  position: fixed;
  inset: 0;
  background: #0f0f0ff5;
  padding: 20px;
  z-index: 100;
  overflow-y: auto;
}

.hidden { display: none; }

.item {
  background: #1f1f1f;
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 12px;
}

.factory {
  border: 1px solid #333;
}

.bar {
  height: 8px;
  background: #333;
  border-radius: 4px;
  overflow: hidden;
  margin: 6px 0;
}

.bar > div {
  height: 100%;
  background: #4caf50;
}

.factory button {
  margin-top: 6px;
  margin-right: 6px;
}

.close {
  width: 100%;
  padding: 12px;
  background: #444;
  border: none;
  color: white;
  border-radius: 10px;
}

/* ===== GRAPH ===== */
canvas {
  width: 100%;
  height: 120px;
  background: #111;
  border-radius: 10px;
  margin-top: 10px;
}
</style>
</head>

<body>
<div id="game">

<header>
  <div>ğŸ¥’ <span id="count">0</span></div>
  <div>Click: <span id="perClick">1</span></div>
</header>

<main>
  <div id="chop-area">
    <img id="knife" src="/assets/images/knife_basic.svg">
    <img id="cucumber" src="/assets/images/cucumber.svg">
  </div>
</main>

<nav>
  <button onclick="openModal('market')">ğŸ›’ Market</button>
  <button onclick="openModal('factories')">ğŸ­ Fabrikalar</button>
</nav>

</div>

<!-- ===== MARKET ===== -->
<div id="market" class="modal hidden">
  <h2>Market</h2>

  <div class="item">
    <strong>Mini Fabrika</strong>
    <p>Ãœretim: 1/sn | Can: 100</p>
    <button onclick="buyFactory()">150 ğŸ¥’</button>
  </div>

  <button class="close" onclick="closeModals()">Kapat</button>
</div>

<!-- ===== FACTORIES ===== -->
<div id="factories" class="modal hidden">
  <h2>FabrikalarÄ±m</h2>
  <div id="factoryList"></div>

  <h3>Verim GrafiÄŸi</h3>
  <canvas id="chart"></canvas>

  <button class="close" onclick="closeModals()">Kapat</button>
</div>

<script>
/* ===== STATE ===== */
let state = JSON.parse(localStorage.getItem("salatalik")) || {
  cucumbers: 0,
  perClick: 1,
  knife: "basic",
  factories: [],
  factoryId: 0
};

/* MIGRATION */
if (!Array.isArray(state.factories)) state.factories = [];
if (typeof state.factoryId !== "number") state.factoryId = 0;

/* ===== ELEMENTS ===== */
const countEl = document.getElementById("count");
const perClickEl = document.getElementById("perClick");
const knifeEl = document.getElementById("knife");
const chopArea = document.getElementById("chop-area");
const factoryList = document.getElementById("factoryList");
const chart = document.getElementById("chart");
const ctx = chart.getContext("2d");

let efficiencyLog = [];

/* ===== CORE ===== */
function save() {
  localStorage.setItem("salatalik", JSON.stringify(state));
}

function updateUI() {
  countEl.textContent = Math.floor(state.cucumbers);
  perClickEl.textContent = state.perClick;
  knifeEl.src = `/assets/images/knife_${state.knife}.svg`;
}

/* ===== CHOP ===== */
chopArea.onclick = () => {
  if (document.querySelector(".modal:not(.hidden)")) return;

  state.cucumbers += state.perClick;
  knifeEl.classList.remove("chop");
  void knifeEl.offsetWidth;
  knifeEl.classList.add("chop");
  spawnSlice();
  save();
  updateUI();
};

function spawnSlice() {
  const s = document.createElement("img");
  s.src = "/assets/images/slice.svg";
  s.className = "slice";
  s.style.setProperty("--x", `${Math.random()*120-60}px`);
  s.style.setProperty("--r", `${Math.random()*180-90}deg`);
  chopArea.appendChild(s);
  setTimeout(() => s.remove(), 800);
}

/* ===== FACTORIES ===== */
function buyFactory() {
  if (state.cucumbers < 150) return;

  state.cucumbers -= 150;
  state.factories.push({
    id: ++state.factoryId,
    level: 1,
    power: 1,
    health: 100,
    maxHealth: 100,
    wearRate: 6,
    wearTimer: 0
  });

  save();
  updateUI();
  updateFactories();
}

function repairFactory(id) {
  const f = state.factories.find(x => x.id === id);
  if (!f) return;

  const cost = Math.ceil((f.maxHealth - f.health) / 2);
  if (state.cucumbers < cost || cost <= 0) return;

  state.cucumbers -= cost;
  f.health = f.maxHealth;
  save();
  updateUI();
  updateFactories();
}

function upgradeFactory(id) {
  const f = state.factories.find(x => x.id === id);
  if (!f) return;

  const cost = f.level * 100;
  if (state.cucumbers < cost) return;

  state.cucumbers -= cost;
  f.level++;
  f.power++;
  f.maxHealth += 50;
  f.health = f.maxHealth;
  f.wearRate += 2;

  save();
  updateUI();
  updateFactories();
}

function updateFactories() {
  factoryList.innerHTML = "";

  state.factories.forEach(f => {
    const percent = (f.health / f.maxHealth) * 100;
    const div = document.createElement("div");
    div.className = "item factory";
    div.innerHTML = `
      <strong>Fabrika #${f.id} (Lv ${f.level})</strong>
      <p>Ãœretim: ${f.power}/sn</p>
      <p>Can: ${Math.floor(f.health)} / ${f.maxHealth}</p>
      <div class="bar"><div style="width:${percent}%"></div></div>
      <button onclick="repairFactory(${f.id})">Tamir</button>
      <button onclick="upgradeFactory(${f.id})">Upgrade</button>
    `;
    factoryList.appendChild(div);
  });
}

/* ===== FACTORY TICK ===== */
setInterval(() => {
  let total = 0;

  state.factories.forEach(f => {
    if (f.health > 0) {
      state.cucumbers += f.power;
      f.wearTimer++;
      if (f.wearTimer >= f.wearRate) {
        f.health -= 1;
        f.wearTimer = 0;
      }
      total += f.power;
    }
  });

  efficiencyLog.push(total);
  if (efficiencyLog.length > 40) efficiencyLog.shift();
  drawChart();

  updateUI();
  updateFactories();
  save();
}, 1000);

/* ===== GRAPH ===== */
function drawChart() {
  chart.width = chart.clientWidth;
  chart.height = chart.clientHeight;
  ctx.clearRect(0,0,chart.width,chart.height);
  ctx.strokeStyle = "#4caf50";
  ctx.beginPath();

  efficiencyLog.forEach((v,i)=>{
    const x = i * (chart.width / efficiencyLog.length);
    const y = chart.height - v * 10;
    ctx.lineTo(x,y);
  });
  ctx.stroke();
}

/* ===== MODALS ===== */
function openModal(id) {
  document.getElementById(id).classList.remove("hidden");
}
function closeModals() {
  document.querySelectorAll(".modal").forEach(m => m.classList.add("hidden"));
}

/* INIT */
updateUI();
updateFactories();
</script>
</body>
</html>
